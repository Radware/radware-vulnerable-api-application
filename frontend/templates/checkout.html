{% extends "base.html" %}

{% block content %}
    <h1>Checkout</h1>
    <div id="checkout-error" class="error-message" style="display:none;"></div> <!-- For specific checkout errors -->
    <div id="checkout-success" class="success-message" style="display:none;"></div> <!-- For specific checkout success -->
    
    <!-- Cart Summary -->
    <div class="profile-section">
        <h2>Order Summary</h2>
        <div id="cart-summary">
            <p class="loading-indicator">Loading cart summary...</p>
        </div>
    </div>
    
    <!-- BOLA Demo for Checkout (single section, covers both scenarios) -->
    <div id="bola-demo-section" class="vulnerability-demo-section">
        <h2>
            <svg class="vulnerability-icon" viewBox="0 0 24 24" width="24" height="24">
                <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z"/>
            </svg>
            BOLA Vulnerability Demo: Order on Behalf of Another User or Use Their Payment
        </h2>
        
        <div class="vulnerability-warning">
            <h3>Security Alert: Broken Object Level Authorization (BOLA)</h3>
            <p>
                This checkout form demonstrates a Broken Object Level Authorization (BOLA) vulnerability.
                By checking the box below, you can attempt to place an order on behalf of another user,
                using their addresses and payment methods if you know their IDs.
            </p>
            <p>
                <strong>In a secure application:</strong> Users should only be able to place orders using their own 
                shipping addresses and payment methods. The backend would verify ownership.
            </p>
        </div>
        
        <form id="checkout-form">
            <div id="normal-checkout-fields" class="profile-section">
                <h3>Your Shipping & Payment Details</h3>
                <div class="form-group">
                    <label for="address-id">Select Shipping Address:</label>
                    <select id="address-id" name="address-id" required class="form-control" data-testid="shipping-address-select">
                        <option value="">Loading addresses...</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="credit-card-id">Select Payment Method:</label>
                    <select id="credit-card-id" name="credit-card-id" required class="form-control" data-testid="payment-method-select">
                        <option value="">Loading payment methods...</option>
                    </select>
                </div>
            </div>
            
            <div id="bola-demo-form" class="vulnerability-exploit-section">
                <h3><span class="exploit-indicator">BOLA</span> Credit Card/User Account Theft Vulnerability Demo</h3>
                <p class="vulnerability-info">This demonstrates a Broken Object Level Authorization vulnerability where you can place an order using another user's account or credit card - a critical security issue in many applications.</p>
                
                <div class="form-group">
                    <label class="vulnerability-input-label">
                        <input type="checkbox" id="order-for-other-user" name="order-for-other-user" data-testid="bola-checkbox">
                        <span class="checkbox-text">Enable BOLA vulnerability exploit</span>
                    </label>
                </div>
                
                <div id="bola-demo-fields" style="display: none;">
                    <div class="attack-steps">
                        <div class="attack-step">
                            <span class="step-number">1</span>
                            <div class="step-content">
                                <h4>Choose Target User</h4>
                                <div class="form-group">
                                    <div class="user-search-container">
                                        <input type="text" id="target-user-id" class="form-control vulnerability-input" placeholder="Enter user ID of the victim">
                                        <button type="button" id="search-users-btn" class="btn btn-sm btn-secondary">Find Users</button>
                                    </div>
                                </div>
                                <div id="user-search-results" style="display: none;" class="vulnerability-search-results">
                                    <h5>Available Victims:</h5>
                                    <div id="user-list" class="demo-result-list"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="attack-step">
                            <span class="step-number">2</span>
                            <div class="step-content">
                                <h4>Steal Address & Credit Card</h4>
                                <div class="form-group">
                                    <div class="card-search-container">
                                        <input type="text" id="target-address-id" class="form-control vulnerability-input" placeholder="Enter address ID to steal">
                                        <button type="button" id="search-addresses-btn" class="btn btn-sm btn-danger">Steal Addresses</button>
                                    </div>
                                </div>
                                <div id="address-search-results" style="display: none;" class="vulnerability-search-results">
                                    <h5>Stolen Addresses:</h5>
                                    <div id="address-list" class="demo-result-list"></div>
                                </div>
                                <div class="form-group">
                                    <div class="card-search-container">
                                        <input type="text" id="target-credit-card-id" class="form-control vulnerability-input" placeholder="Enter credit card ID to steal">
                                        <button type="button" id="search-cards-btn" class="btn btn-sm btn-danger">Steal Cards</button>
                                    </div>
                                </div>
                                <div id="card-search-results" style="display: none;" class="vulnerability-search-results">
                                    <h5>Stolen Credit Cards:</h5>
                                    <div id="card-list" class="demo-result-list"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="attack-step">
                            <span class="step-number">3</span>
                            <div class="step-content">
                                <h4>Preview Theft</h4>
                                <div id="theft-preview" class="theft-preview">
                                    <div class="no-theft-selected">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="target-user-info" style="display: none;" class="target-user-preview">
                        <!-- This will be filled with JavaScript -->
                    </div>
                </div>
                
                <div id="bola-vulnerability-banner" class="vulnerability-warning" style="display: none;">
                    <div class="warning-icon">⚠️</div>
                    <div class="warning-content">
                        <h3>BOLA Vulnerability Exploit Active</h3>
                        <p>You are about to exploit a Broken Object Level Authorization vulnerability by charging your purchase to another user's account or payment method.</p>
                        <div class="security-impact">
                            <span>Security Impact:</span>
                            <div class="impact-meter high">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <div style="text-align:right; margin-top: 24px;">
            <button type="submit" form="checkout-form" id="place-order-btn" class="btn btn-primary">Place Order</button>
        </div>
    </div>
    <div id="global-message-container"></div> 
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/checkout.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // main.js initCheckoutPage will call populateAddressDropdown and populateCreditCardDropdown.
        // checkout.js setupCheckoutBOLADemo will handle the BOLA checkbox UI.
        
        // Set up the checkout form submission handler
        const checkoutForm = document.getElementById('checkout-form');
        if (checkoutForm) {
            checkoutForm.addEventListener('submit', handleCheckoutSubmit);
        }
        
        // Set up BOLA demo features
        setupCheckoutBOLADemo();
        
        // Ensure the specific BOLA warning container exists for checkout.js
        const bolaWarningContainer = document.getElementById('bola-checkout-warning-container');
        if (bolaWarningContainer && !document.getElementById('bola-warning-container')) {
            bolaWarningContainer.id = 'bola-warning-container';
        }
    });
</script>
{% endblock %}